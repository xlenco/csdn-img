<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- noreferer -->
    <meta name="referrer" content="no-referrer" />
    <link rel="shortcut icon" href="https://file.onmicrosoft.cn/favicon.ico">
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
    <title>ç®€å•çš„ CSDN ä¸Šä¼ æ¥å£</title>
    <script src="https://unpkg.onmicrosoft.cn/vue@2.7.14/dist/vue.js"></script>
    <script src="https://unpkg.onmicrosoft.cn/element-ui@2.15.10/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.onmicrosoft.cn/element-ui@2.15.10/lib/theme-chalk/index.css" />
    <script src="https://unpkg.onmicrosoft.cn/dayjs@1.8.21/dayjs.min.js"></script>
    <script src="https://unpkg.onmicrosoft.cn/axios@1.2.5/dist/axios.min.js"></script>
    <style>
        /* å®½å¸¦å¤§äº750æ—¶ä¸¤æ  */
        @media screen and (min-width: 750px) {
            .auto {
                display: flex;
                justify-content: space-evenly;
            }
        }

        @media screen and (max-width: 750px) {
            .el-button+.el-button {
                margin-top: 10px;
                margin-left: 0;
            }
        }

        .demo-table-expand {
            font-size: 0;
        }

        .demo-table-expand label {
            color: #99a9bf;
        }

        .demo-table-expand .el-form-item {
            margin-right: 0;
            margin-bottom: 0;
            width: 100%;
            padding-left: 15px;
        }
    </style>
</head>

<body>
    <div id="app" @paste="handlePaste">
        <center>
            <div class="auto">
                <div>
                    <h2>CSDN é˜¿é‡Œäº‘å›¾åºŠæ¥å£</h2>
                    <el-upload ref="oss_uploader" class="upload-demo" drag action="https://csdn-img.onmicrosoft.cn/"
                        multiple name="file" :before-upload="OSSBeforeUpload" :data="oss_detail" :on-success="OSS_Suc"
                        drag="true">
                        <i class="el-icon-upload"></i>
                        <div class="el-upload__text">
                            å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em>
                        </div>
                        <div class="el-upload__tip" slot="tip">
                            åªæ”¯æŒpngã€jpgã€jpegã€gifç±»å‹çš„å›¾ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒç²˜è´´å›¾ç‰‡ä¸Šä¼ ï¼‰
                        </div>
                    </el-upload>
                </div>
            </div>

            <div class="history">
                <h2>å†å²è®°å½•</h2>
                <el-table :data="tableData" style="width: 800px" stripe>
                    <el-table-column prop="url" label="é¢„è§ˆ" align="center">
                        <template slot-scope="item">
                            <el-image style="width: 100px; height: 100px" :src="item.row.url" fit="scale-down"
                                :preview-src-list="[item.row.url]" lazy>
                            </el-image>
                        </template>

                    </el-table-column>

                    <el-table-column prop="url" label="é“¾æ¥" width="500" align="center"></el-table-column>
                    <el-table-column fixed="right" label="æ“ä½œ" width="160" align="center">
                        <template slot-scope="scope" align="center">
                            <el-button @click="handleCopy(scope.row.url, 'ç›´é“¾')" type="primary"
                                size="small">å¤åˆ¶</el-button>
                            <el-button @click="handleDel(scope.row)" type="danger" size="small">åˆ é™¤</el-button>
                        </template>
                    </el-table-column>
                </el-table>

            </div>
            <!-- {{oss_all}} -->

        </center>
    </div>

    <script>
        var Main = {
            // tableData ä» localstorage é‡Œé¢å–
            data() {
                return {
                    oss_detail: {
                        "key": "",
                        "signature": "",
                        "OSSAccessKeyId": "",
                        "policy": "",
                    },
                    oss_all: {},
                    tableData: [],
                    FILE_DICT: {},
                };
            },
            methods: {
                loadHistory() {
                    var list = localStorage.getItem("History") ? JSON.parse(localStorage.getItem("History")) : [{ "date": "2023å¹´01æœˆ27æ—¥ 19:18:30", "url": "https://img-blog.csdnimg.cn/3e45127261234440ba21277d356538e2.png", "name": "Screenshot 2023-01-27 at 19.18.16.png" }];
                    list = list.reverse();
                    this.tableData = list;
                },
                OSSBeforeUpload(file, fileList) {
                    // åªæ”¯æŒpngã€jpgã€jpegã€gifç±»å‹çš„å›¾ç‰‡ä¸Šä¼ 
                    let isJPG = file.type === 'image/jpeg' || file.type === 'image/jpg';
                    let isPNG = file.type === 'image/png';
                    let isGIF = file.type === 'image/gif';
                    if (!isJPG && !isPNG && !isGIF) {
                        this.$message.error('ä¸Šä¼ æ–‡ä»¶å›¾ç‰‡åªèƒ½æ˜¯ JPGã€PNGã€GIF æ ¼å¼!');
                        return false;
                    }
                    let _self = this;
                    let extension = file.name.split(".").pop()
                    return new Promise((resolve, reject) => {
                        this.postPolicy(extension)
                            .then((response) => {
                                _self.oss_all = response.data.data;
                                _self.oss_detail.key = response.data.data.filePath;
                                _self.oss_detail.signature = response.data.data.signature;
                                _self.oss_detail.OSSAccessKeyId = response.data.data.accessId;
                                _self.oss_detail.policy = response.data.data.policy;
                                _self.oss_detail.callback = response.data.data.callbackUrl;
                                _self.oss_detail.success_action_status = 200;
                                _self.FILE_DICT[file.uid] = {}
                                _self.FILE_DICT[file.uid].nickname = JSON.parse(JSON.stringify(file.name))
                                resolve(true);
                            })
                            .catch((err) => {
                                reject(false);
                            });
                    });
                },
                OSS_Suc(response, file, fileList) {
                    let history_item = JSON.parse(localStorage.getItem("History"));
                    if (history_item == undefined) {
                        history_item = []
                    }
                    let nickname = this.FILE_DICT[file.uid].nickname
                    history_item.push(
                        {
                            "date": dayjs().format('YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss'),
                            "url": response.data.imageUrl,
                            "name": nickname
                        }
                    )
                    localStorage.setItem("History", JSON.stringify(history_item));
                    this.loadHistory();
                },
                postPolicy(extension) {
                    return new Promise((resolve, reject) => {
                        // ä¸Šè¿°è¯·æ±‚ä¹Ÿå¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼å®Œæˆï¼ˆå¯é€‰ï¼‰
                        axios.get('https://hub.onmicrosoft.cn/public/pic/csdn.' + extension)
                            .then(function (response) {
                                resolve(response);
                            })
                            .catch(function (error) {
                                console.log(error);
                            })
                            .then(function () {
                                // æ€»æ˜¯ä¼šæ‰§è¡Œ
                            });

                    });
                },
                handleCopy(content, name) {

                    var aux = document.createElement("input");
                    aux.setAttribute("value", content);
                    document.body.appendChild(aux);
                    aux.select();
                    document.execCommand("copy");
                    document.body.removeChild(aux);
                    this.$message({
                        message: name + ' ğŸ”— å¤åˆ¶æˆåŠŸï¼',
                        type: 'success'
                    });
                },
                handleDel(row_data) {
                    this.$confirm('æ­¤æ“ä½œåªæ˜¯ä»åˆ—è¡¨ä¸­åˆ é™¤æ–‡ä»¶, æ–‡ä»¶é“¾æ¥ä»æœ‰æ•ˆï¼Œæ˜¯å¦ç»§ç»­?', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning'
                    }).then(() => {
                        let history_item = JSON.parse(localStorage.getItem("History"));
                        let _index;
                        try {
                            _index = history_item.findIndex(element => element['url'] === row_data['url']);
                        } catch (e) {
                            this.$message({
                                type: 'warning',
                                message: 'ç¤ºä¾‹å›¾ç‰‡æ— éœ€åˆ é™¤ï¼Œä¸Šä¼ æ–°æ–‡ä»¶å³å¯è¦†ç›–ã€‚'
                            });
                        }
                        history_item.splice(_index, 1)
                        localStorage.setItem("History", JSON.stringify(history_item))
                        this.loadHistory();

                        this.$message({
                            type: 'success',
                            message: 'åˆ é™¤æˆåŠŸ!'
                        });
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: 'å·²å–æ¶ˆåˆ é™¤'
                        });
                    });
                },
                // ç›‘å¬ç²˜è´´æ“ä½œ
                handlePaste(event) {
                    this.$message.success("")
                    const items = (event.clipboardData || window.clipboardData).items;
                    let file = null;
                    if (!items || items.length === 0) {
                        this.$message.error("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæœ¬åœ°");
                        return;
                    }
                    // æœç´¢å‰ªåˆ‡æ¿items
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf("image") !== -1) {
                            file = items[i].getAsFile();
                            break;
                        }
                    }
                    if (!file) {
                        this.$message.error("ç²˜è´´å†…å®¹éå›¾ç‰‡");
                        return;
                    }
                    this.$message.success("å›¾ç‰‡ä¸Šä¼ ä¸­...");
                    this.$refs.oss_uploader.handleStart(file);// å°†ç²˜è´´è¿‡æ¥çš„å›¾ç‰‡åŠ å…¥é¢„ä¸Šä¼ é˜Ÿåˆ—
                    this.$refs.oss_uploader.submit(); // æäº¤å›¾ç‰‡ä¸Šä¼ é˜Ÿåˆ—
                },
            },
            created() {
                this.loadHistory();
            },
        };
        var Vue = Vue.extend(Main);

        new Vue().$mount("#app");



    </script>
</body>

</html>
